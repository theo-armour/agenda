var appCombined=new Vue({el:'#app',data:function(){return{servings:2,showBacklink:!0,measure:'metric',viewStyle:'grid',ingredients:'2 medium zucchini\n2 cups chicken cooked and shredded\n3 ounces cream cheese\n1/4 cup ranch\n1/2 cup shredded cheddar\n1/8 cup buffalo sauce\n1/2 cup shredded mozzarella cheese',isLoading:!1,error:null,servingSize:null,weightBreakdown:null,totalWeight:null,calculateServingSizes:!1}},watch:{servings(newValue){if(newValue<=0){this.servings=1}}},mounted(){if(!spoonacular_vn.api_key){this.error=spoonacular_vn.i18n.error_api_key}
spoonacular_vn.api_key=decodeURIComponent(window.atob(spoonacular_vn.api_key))},methods:{async calculateServingSize(){try{const controller=new AbortController();const timeoutId=setTimeout(()=>controller.abort(),45000);const response=await fetch(spoonacular_vn.ajax_url,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded',},body:new URLSearchParams({action:'calculate_serving_size',nonce:spoonacular_vn.nonce,ingredients:this.ingredients,servings:this.servings}),signal:controller.signal});clearTimeout(timeoutId);const data=await response.json();if(!data.success){throw new Error(data.data||'Failed to calculate serving size')}
this.servingSize=Math.round(data.data.weight_per_serving);this.totalWeight=Math.round(data.data.total_weight);this.weightBreakdown=data.data.breakdown}catch(error){console.error('Failed to calculate serving size:',error);if(error.name==='AbortError'){this.error='The request took too long to process. Please try again.'}else{this.error=error.message}
this.servingSize=null;this.totalWeight=null;this.weightBreakdown=null}},async makeApiRequest(endpoint,data){const url=`https://api.spoonacular.com/recipes/${endpoint}?apiKey=${spoonacular_vn.api_key}`;try{const response=await fetch(url,{method:'POST',body:new URLSearchParams(data)});if(!response.ok){throw new Error(`API request failed: ${response.status}`)}
return await response.text()}catch(error){console.error('API request failed:',error);throw new Error(spoonacular_vn.i18n.error_api_request)}},async previewNutritionWidget(){try{const response=await this.makeApiRequest('visualizeNutrition',{defaultCss:!0,servings:this.servings,ingredientList:this.ingredients});this.previewNutritionWidgetCallback(response)}catch(error){this.error=error.message}},previewNutritionWidgetCallback(response){const iframe=document.getElementById('previewWidget');const iframeDocument=iframe.contentDocument;const jqueryScript=document.createElement("script");jqueryScript.src="https://code.jquery.com/jquery-1.9.1.min.js";iframeDocument.head.appendChild(jqueryScript);const canvasScript=document.createElement("script");canvasScript.src="https://spoonacular.com/application/frontend/js/jquery.canvasjs.min";iframeDocument.head.appendChild(canvasScript);jqueryScript.onload=()=>{iframeDocument.open();iframeDocument.write(response);iframeDocument.close();const widgetScript=document.createElement("script");widgetScript.src="https://spoonacular.com/application/frontend/js/nutritionWidget.min.js?c=1";iframeDocument.body.appendChild(widgetScript);const styleSheet=document.createElement("link");styleSheet.rel="stylesheet";styleSheet.href=`${spoonacular_vn.site_url}/wp-content/plugins/spoonacular-visualize-nutrition/assets/css/spoonacular-vn-iframe.css?ver=1.0.10`;iframeDocument.head.appendChild(styleSheet);iframe.classList.remove('hidden');iframe.style.height=`${iframeDocument.body.scrollHeight}px`}},async previewIngredientWidget(){try{const response=await this.makeApiRequest('visualizeIngredients',{defaultCss:!0,servings:this.servings,view:this.viewStyle,measure:this.measure,ingredientList:this.ingredients});this.previewIngredientWidgetCallback(response)}catch(error){this.error=error.message}},previewIngredientWidgetCallback(response){const iframe=document.getElementById('previewIngredientWidget');const iframeDocument=iframe.contentDocument;iframeDocument.open();iframeDocument.write(response);iframeDocument.close();const jqueryScript=document.createElement("script");jqueryScript.src="https://code.jquery.com/jquery-1.9.1.min.js";iframeDocument.head.appendChild(jqueryScript);jqueryScript.onload=()=>{const widgetScript=document.createElement("script");widgetScript.src="https://spoonacular.com/application/frontend/js/ingredientWidget.min.js?c=1";iframeDocument.body.appendChild(widgetScript);const styleSheet=document.createElement("link");styleSheet.rel="stylesheet";styleSheet.href=`${spoonacular_vn.site_url}/wp-content/plugins/spoonacular-visualize-nutrition/assets/css/spoonacular-vn-iframe.css?ver=1.0.10`;iframeDocument.head.appendChild(styleSheet);iframe.classList.remove('hidden');iframe.style.height=`${iframeDocument.body.scrollHeight}px`}},async analyzeRecipe(){if(!spoonacular_vn.api_key){this.error=spoonacular_vn.i18n.error_api_key;return}
if(this.servings<=0){this.error='Number of servings must be greater than 0';return}
this.isLoading=!0;this.error=null;this.servingSize=null;this.weightBreakdown=null;this.totalWeight=null;try{const tasks=[this.previewNutritionWidget(),this.previewIngredientWidget()];if(this.calculateServingSizes){const retryServingSize=async(retries=2)=>{try{await this.calculateServingSize()}catch(error){if(retries>0&&(error.message.includes('timeout')||error.message.includes('too long'))){await new Promise(resolve=>setTimeout(resolve,2000));return retryServingSize(retries-1)}
throw error}};tasks.push(retryServingSize())}
await Promise.all(tasks)}catch(error){this.error=error.message}finally{this.isLoading=!1}}}})